<script src="three.min.js"></script>
<script src="waterway.js"></script>
<script>
onload=function(){
  var width=800,height=600
  camera = new THREE.Camera();
  camera = new THREE.PerspectiveCamera(40, width / height, 0.1, 1000);
  camera.position.z = 4;
  camera.lookAt({x:0,y:0,z:0});
  camera.initialRotation=camera.rotation.clone()
  scene = new THREE.Scene();
  material = new THREE.MeshLambertMaterial({color: 0x887766})
  var dlight = new THREE.DirectionalLight(0x999999);
  var alight = new THREE.AmbientLight(0x666666);
  dlight.position.set(1, 1, 1).normalize();
  scene.add(dlight,alight);
  chara = new THREE.Mesh(new THREE.BoxGeometry(1.6, 1, 1), material);
  scene.add(chara);
  var size=10;
  scale=20;
  renderer = new THREE.WebGLRenderer();
  renderer.setClearColor(new THREE.Color(0xaaaaaa));
  renderer.setSize(800,600);
  document.body.appendChild(renderer.domElement);
  animate();
}
var Key={LEFT:37,UP:38,RIGHT:39,DOWN:40,map:{}};
document.onkeydown=function(e){
  Key.map[e.keyCode]=true;
}
document.onkeyup=function(e){
  Key.map[e.keyCode]=false;
}
var pos={x:0,y:0,th:0,rot:0,vx:0,vy:0}
var camth=0;
var score=0;
var barvalue=100;
var damage=0;
var state='start'
var chunkSize=4
var numChunks=1;
var chunks = {};
var items = []
function animate(){
  var chunkx=Math.round(pos.x/chunkSize/scale);
  var chunky=Math.round(pos.y/chunkSize/scale);
  for(var key in chunks)chunks[key].count++;
  for(var i=chunkx-numChunks;i<=chunkx+numChunks;i++){
    for(var j=chunky-numChunks;j<=chunky+numChunks;j++){
      var chunk = chunks[[i,j]];
      if(!chunk){
        console.log('gen',i,j);
        chunk=chunks[[i,j]]=new WaterwayChunk(i,j,chunkSize,scale,scene);
        chunk.mesh.material=material;
      }
      chunk.count=0;
    }
  }
  var oldchunks=Object.keys(chunks).map(function(key){return chunks[key]});
  oldchunks.sort(function(a,b){return a.count-b.count});
  while(oldchunks.length>(2*numChunks+2)*(2*numChunks+2)){
    var chunk = oldchunks.pop();
    delete chunks[[chunk.i,chunk.j]];
    chunk.dispose();
    scene.remove(chunk.mesh);
  }


  var $message=document.querySelector('#message')
  if(state=='start'){
    $message.style.display='block';
    if(Key.map[32])state='game';
    $message.innerHTML='press space<br>move: arrows';
  }
  if(state=='gameover'){
    $message.style.display='block';
    $message.innerHTML='game over<br>press space';
    if(Key.map[32]){
      score=0;barvalue=100;
      state='game';
    }
  }
  if(state=='game'){
    $message.style.display='none';
    barvalue-=0.05;
    for(var key in chunks){
      var count = chunks[key].update(pos);
      for(var i=0;i<count;i++){
        if(barvalue>100){
          score+=count*200;
        }else{
          score+=Math.round(count*(10+0.9*barvalue))
        }
        barvalue += 5;
        if(barvalue>140)barvalue=140;
      }
    }
    if(barvalue<0){barvalue=0;state='gameover';}
    document.querySelector('#bar_inner').style.width=barvalue+'%';
    document.querySelector('#bar').className = barvalue>100?'gold':'';
    document.querySelector('#score').innerHTML = 'score: '+ score;
  }

  if(Key.map[Key.LEFT])pos.rot+=0.01;
  if(Key.map[Key.RIGHT])pos.rot-=0.01;
  if(damage==0){
    var v=(Key.map[Key.UP]?1:0)-(Key.map[Key.DOWN]?1:0);
    pos.vx+=Math.cos(pos.th)*0.004*v;
    pos.vy+=Math.sin(pos.th)*0.004*v;
  }
  var cos=Math.cos(pos.th),sin=Math.sin(pos.th);
  var pvx=(cos*pos.vx+sin*pos.vy)*cos*0.99+0.96*(-cos*pos.vy+sin*pos.vx)*sin;
  var pvy=(cos*pos.vx+sin*pos.vy)*sin*0.99-0.96*(-cos*pos.vy+sin*pos.vx)*cos;
  pos.vx=pvx;
  pos.vy=pvy;
  var hit=false;
  var triangles=[];
  for(var key in chunks){
    triangles.push.apply(triangles,chunks[key].triangles);
  }
  triangles.forEach(function(tri){
    hit=hit||hitTest(tri,{x:pos.x,y:pos.y},0.1).length;
  })
  for(var i=0;i<2;i++){
    var hit2=[];
    triangles.forEach(function(tri){
      hit2.push.apply(hit2,hitTest(tri,{x:(pos.x+pos.vx),y:(pos.y+pos.vy)},0.5));
    })
    if(!hit&&!!hit2.length){
      var normal={x:0,y:0}
      hit2.forEach(function(n){
        normal.x+=n.x;normal.y+=n.y;
      });
      var nr=Math.sqrt(normal.x*normal.x+normal.y*normal.y);
      normal.x/=nr;normal.y/=nr;
      var vn=pos.vx*normal.x+pos.vy*normal.y;
      if(vn>0){
        pos.vx-=1.5*vn*normal.x
        pos.vy-=1.5*vn*normal.y
      }
      if(pos.vx*pos.vx+pos.vy*pos.vy<0.01*0.01)pos.vx=pos.vy=0;
      if(damage==0)damage=1;
    }else{
      pos.x+=pos.vx;pos.y+=pos.vy;
      break;
    }
  }
  damage=Math.max(damage-0.02,0);
  chara.position.x=pos.x;
  chara.position.y=pos.y;
  chara.setRotationFromAxisAngle({x:0,y:0,z:1},pos.th)
  pos.rot*=0.8;
  pos.th+=pos.rot;
  camth=camth*0.8+pos.th*0.2;
  camera.position.x=camera.position.x*0.8+0.2*(pos.x-1*Math.cos(pos.th))
  camera.position.y=camera.position.y*0.8+0.2*(pos.y-1*Math.sin(pos.th))
  camera.position.z=20*(Key.map[27]?32:1);
  camera.setRotationFromAxisAngle({x:1,y:0,z:0},0)
  camera.rotateZ(camth-Math.PI/2)
  camera.rotateX(0.2);
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}

function triInside(tri, p){
  var da={x:tri[1].x-tri[0].x,y:tri[1].y-tri[0].y};
  var db={x:tri[2].x-tri[0].x,y:tri[2].y-tri[0].y};
  var area=Math.abs(da.x*db.y-da.y*db.x);
  var area2=0;
  for(var i=0;i<3;i++){
    var a=tri[i],b=tri[(i+1)%3];
    area2+=Math.abs((a.x-p.x)*(b.y-p.y)-(a.y-p.y)*(b.x-p.x));
  }
  return (area2-area)/area<0.0001;
}
function hitTest(tri,p,r){
  var normals=[];
  for(var i=0;i<tri.length;i++){
    var a=tri[i],b=tri[(i+1)%3];
    var dx=b.x-a.x,dy=b.y-a.y;
    var x=p.x-a.x,y=p.y-a.y;
    if(x*x+y*y>r*r&&(p.x-b.x)*(p.x-b.x)+(p.y-b.y)*(p.y-b.y)>r*r){
      var dd=dx*dx+dy*dy;
      var dc=dx*x+dy*y;
      var cc=x*x+y*y;
      var t=dc/dd;
      if(t<0||t>1||dd*t*t-2*dc*t+cc>r*r)continue;
    }
    var dr=Math.sqrt(dx*dx+dy*dy);
    normals.push({x:-dy/dr,y:dx/dr});
  }
  return normals;
}
</script>
<style>
div{z-index:1;position:absolute;}
canvas{position:absolute;left:0px;top:0px;}
#score{
  left: 10px;
  top: 20px;
  color: white;
  font-weight: bold;
  text-shadow: 0 0 2px gray;
  font-size: 18px;
  font-family: sans-serif;
}
#bar{
  left: 20px;
  top: 5px;
  width: 760px;
  height: 6px;
  border-radius: 3px;
  background: rgba(0,0,0,0.4);
  overflow: hidden;
}
#bar_inner{
  width:50%;
  height:100%;
  background: white;
  opacity: 0.8;
}
#bar.gold{opacity: 1;box-shadow: 0 0 8px yellow;}
#bar.gold #bar_inner{opacity: 1;width: 100%;}
#message{
  width: 300px;
  height:200px;
  left:200px;
  top:150px;
  padding: 50px;
  border-radius: 20px;
  background:white;
  opacity: 0.8;
  font-size: 20px;
  font-family: sans-serif;
}
</style>
<div id='score'>score:123</div>
<div id='bar'  class='gold'><div id='bar_inner'></div></div>
<div id='message'></div>