<script src="three.min.js"></script>
<script src="waterway.js"></script>
<script>
onload=function(){
  var width=800,height=600
  camera = new THREE.Camera();
  camera = new THREE.PerspectiveCamera(40, width / height, 0.1, 1000);
  camera.position.z = 4;
  camera.lookAt({x:0,y:0,z:0});
  camera.initialRotation=camera.rotation.clone()
  scene = new THREE.Scene();
  var material = new THREE.MeshLambertMaterial({color: 0x887766})
  var dlight = new THREE.DirectionalLight(0x999999);
  var alight = new THREE.AmbientLight(0x666666);
  dlight.position.set(1, 1, 1).normalize();
  scene.add(dlight,alight);
  chara = new THREE.Mesh(new THREE.BoxGeometry(1.6, 1, 1), material);
  scene.add(chara);
  var size=10;
  scale=20;
  triangles = genWaterWay(-size/2,-size/2,size,size).triangles
  triangles.forEach(function(tri){
    tri=tri.map(function(p){return {x:p.x,y:p.y,z:1+Math.sin(1234*p.x+5432*p.y)}})
    var mesh=genPrismMesh(tri);
    mesh.scale.x=mesh.scale.y=scale;
    mesh.material=material;
    scene.add(mesh);
    for(var i=0;i<3;i++){
      var a=tri[i],b=tri[(i+1)%3];
      var d={x:b.x-a.x,y:b.y-a.y};
      var dr=Math.sqrt(d.x*d.x+d.y*d.y);
      d.x/=dr;d.y/=dr;
      for(var j=0;j<2;j++){
        var w=0.1+0.3*Math.random();
        var h=0.1+0.3*Math.random();
        var x=(dr-w)*Math.random();
        var y=0.05*Math.random();
        var p00={x:a.x+d.x*x-d.y*y,y:a.y+d.y*x+d.x*y};
        var p10={x:a.x+d.x*(x+w)-d.y*y,y:a.y+d.y*(x+w)+d.x*y};
        var p01={x:a.x+d.x*x-d.y*(y+h),y:a.y+d.y*x+d.x*(y+h)};
        var p11={x:a.x+d.x*(x+w)-d.y*(y+h),y:a.y+d.y*(x+w)+d.x*(y+h)};
        if(triInside(tri,p00)&&triInside(tri,p01)&&triInside(tri,p10)&&triInside(tri,p11)){
          var building=genPrismMesh([p00,p10,p11,p01],4+8*Math.random());
          building.scale.x=building.scale.y=scale;
          scene.add(building);
          building.material=material;
        }
      }
    }
  })
  renderer = new THREE.WebGLRenderer();
  renderer.setClearColor(new THREE.Color(0xaaaaaa));
  renderer.setSize(800,600);
  document.body.appendChild(renderer.domElement);
  animate();
}
var Key={LEFT:37,UP:38,RIGHT:39,DOWN:40,map:{}};
document.onkeydown=function(e){
  Key.map[e.keyCode]=true;
}
document.onkeyup=function(e){
  Key.map[e.keyCode]=false;
}
var pos={x:4,y:11,th:0,rot:0,vx:0,vy:0}
var camth=0;
var damage=0;
function animate(){
  if(Key.map[Key.LEFT])pos.rot+=0.01;
  if(Key.map[Key.RIGHT])pos.rot-=0.01;
  if(damage<0.5){
    var v=(Key.map[Key.UP]?1:0)-(Key.map[Key.DOWN]?1:0);
    pos.vx+=Math.cos(pos.th)*0.004*v;
    pos.vy+=Math.sin(pos.th)*0.004*v;
  }
  var cos=Math.cos(pos.th),sin=Math.sin(pos.th);
  var pvx=(cos*pos.vx+sin*pos.vy)*cos*0.99+0.96*(-cos*pos.vy+sin*pos.vx)*sin;
  var pvy=(cos*pos.vx+sin*pos.vy)*sin*0.99-0.96*(-cos*pos.vy+sin*pos.vx)*cos;
  pos.vx=pvx;
  pos.vy=pvy;
  var hit=false;
  triangles.forEach(function(tri){
    hit=hit||hitTest(tri,{x:pos.x/scale,y:pos.y/scale},0.5/scale).length;
  })
  for(var i=0;i<2;i++){
    var hit2=[];
    triangles.forEach(function(tri){
      hit2.push.apply(hit2,hitTest(tri,{x:(pos.x+pos.vx)/scale,y:(pos.y+pos.vy)/scale},0.5/scale));
    })
    if(!hit&&!!hit2.length){
      var normal={x:0,y:0}
      hit2.forEach(function(n){
        normal.x+=n.x;normal.y+=n.y;
      });
      var nr=Math.sqrt(normal.x*normal.x+normal.y*normal.y);
      normal.x/=nr;normal.y/=nr;
      var vn=pos.vx*normal.x+pos.vy*normal.y;
      if(vn>0){
        pos.vx-=1.5*vn*normal.x
        pos.vy-=1.5*vn*normal.y
      }
      if(pos.vx*pos.vx+pos.vy*pos.vy<0.01*0.01)pos.vx=pos.vy=0;
      damage=1;
    }else{
      pos.x+=pos.vx;pos.y+=pos.vy;
      break;
    }
  }
  damage*=0.9;
  chara.position.x=pos.x;
  chara.position.y=pos.y;
  chara.setRotationFromAxisAngle({x:0,y:0,z:1},pos.th)
  pos.rot*=0.8;
  pos.th+=pos.rot;
  camth=camth*0.8+pos.th*0.2;
  camera.position.x=camera.position.x*0.8+0.2*(pos.x-1*Math.cos(pos.th))
  camera.position.y=camera.position.y*0.8+0.2*(pos.y-1*Math.sin(pos.th))
  camera.position.z=20;
  camera.setRotationFromAxisAngle({x:1,y:0,z:0},0)
  camera.rotateZ(camth-Math.PI/2)
  camera.rotateX(0.2);
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}

function triInside(tri, p){
  var da={x:tri[1].x-tri[0].x,y:tri[1].y-tri[0].y};
  var db={x:tri[2].x-tri[0].x,y:tri[2].y-tri[0].y};
  var area=Math.abs(da.x*db.y-da.y*db.x);
  var area2=0;
  for(var i=0;i<3;i++){
    var a=tri[i],b=tri[(i+1)%3];
    area2+=Math.abs((a.x-p.x)*(b.y-p.y)-(a.y-p.y)*(b.x-p.x));
  }
  return (area2-area)/area<0.0001;
}
function hitTest(tri,p,r){
  var normals=[];
  for(var i=0;i<tri.length;i++){
    var a=tri[i],b=tri[(i+1)%3];
    var dx=b.x-a.x,dy=b.y-a.y;
    var x=p.x-a.x,y=p.y-a.y;
    if(x*x+y*y>r*r&&(p.x-b.x)*(p.x-b.x)+(p.y-b.y)*(p.y-b.y)>r*r){
      var dd=dx*dx+dy*dy;
      var dc=dx*x+dy*y;
      var cc=x*x+y*y;
      var t=dc/dd;
      if(t<0||t>1||dd*t*t-2*dc*t+cc>r*r)continue;
    }
    var dr=Math.sqrt(dx*dx+dy*dy);
    normals.push({x:-dy/dr,y:dx/dr});
  }
  return normals;
}


</script>
