<script src="three.min.js"></script>
<script src="waterway.js"></script>
<script>
onload=function(){
  var width=800,height=600
  camera = new THREE.Camera();
  camera = new THREE.PerspectiveCamera(40, width / height, 0.1, 1000);
  camera.position.z = 4;
  camera.lookAt({x:0,y:0,z:0});
  camera.initialRotation=camera.rotation.clone()
  scene = new THREE.Scene();
  chara = new THREE.Mesh(new THREE.BoxGeometry(1, 1, 1));
  scene.add(chara);
  var size=10;
  genWaterWay(-size/2,-size/2,size,size).triangles.forEach(function(tri){
    tri.map(function(p){return {x:p.x,y:p.y,z:1+0.5*Math.sin(1234*p.x+5432*p.y)}})
    var mesh=genPrismMesh(tri,1);
    var scale=20;
    mesh.scale.x=mesh.scale.y=scale;
    scene.add(mesh);
    for(var i=0;i<3;i++){
      var a=tri[i],b=tri[(i+1)%3];
      var d={x:b.x-a.x,y:b.y-a.y};
      var dr=Math.sqrt(d.x*d.x+d.y*d.y);
      d.x/=dr;d.y/=dr;
      for(var j=0;j<4;j++){
        var w=0.1+0.1*Math.random();
        var h=0.1+0.1*Math.random();
        var x=(dr-w)*Math.random();
        var y=0.05*Math.random();
        var p00={x:a.x+d.x*x-d.y*y,y:a.y+d.y*x+d.x*y};
        var p10={x:a.x+d.x*(x+w)-d.y*y,y:a.y+d.y*(x+w)+d.x*y};
        var p01={x:a.x+d.x*x-d.y*(y+h),y:a.y+d.y*x+d.x*(y+h)};
        var p11={x:a.x+d.x*(x+w)-d.y*(y+h),y:a.y+d.y*(x+w)+d.x*(y+h)};
        if(triInside(tri,p00)&&triInside(tri,p01)&&triInside(tri,p10)&&triInside(tri,p11)){
          var building=genPrismMesh([p00,p10,p11,p01],4+4*Math.random());
          building.scale.x=building.scale.y=scale;
          scene.add(building);
        }

      }


    }
  })


  // water = new THREE.Mesh(new THREE.PlaneBufferGeometry(200,200));
  // scene.add(water);
  renderer = new THREE.WebGLRenderer();
  renderer.setClearColor(new THREE.Color(0x000000));
  renderer.setSize(800,600);
  document.body.appendChild(renderer.domElement);
  animate();
}
var Key={LEFT:37,UP:38,RIGHT:39,DOWN:40,map:{}};
document.onkeydown=function(e){
  Key.map[e.keyCode]=true;
}
document.onkeyup=function(e){
  Key.map[e.keyCode]=false;
}
var pos={x:4,y:11,th:0,rot:0,vx:0,vy:0}
var camth=0;
function animate(){
  var v=(Key.map[Key.UP]?1:0)-(Key.map[Key.DOWN]?1:0);
  pos.vx+=Math.cos(pos.th)*0.02*v;
  pos.vy+=Math.sin(pos.th)*0.02*v;
  pos.vx*=0.9;pos.vy*=0.9;
  pos.x+=pos.vx;pos.y+=pos.vy;
  chara.position.x=pos.x;
  chara.position.y=pos.y;
  chara.setRotationFromAxisAngle({x:0,y:0,z:1},pos.th)
  if(Key.map[Key.LEFT])pos.rot+=0.01;
  if(Key.map[Key.RIGHT])pos.rot-=0.01;
  pos.rot*=0.8;
  pos.th+=pos.rot;
  camth=camth*0.8+pos.th*0.2;
  camera.position.x=camera.position.x*0.8+0.2*(pos.x-1*Math.cos(pos.th))
  camera.position.y=camera.position.y*0.8+0.2*(pos.y-1*Math.sin(pos.th))
  camera.position.z=10;
  camera.setRotationFromAxisAngle({x:1,y:0,z:0},0)
  camera.rotateZ(camth-Math.PI/2)
  camera.rotateX(0.2);
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}

function triInside(tri, p){
  var da={x:tri[1].x-tri[0].x,y:tri[1].y-tri[0].y};
  var db={x:tri[2].x-tri[0].x,y:tri[2].y-tri[0].y};
  var area=Math.abs(da.x*db.y-da.y*db.x);
  var area2=0;
  for(var i=0;i<3;i++){
    var a=tri[i],b=tri[(i+1)%3];
    area2+=Math.abs((a.x-p.x)*(b.y-p.y)-(a.y-p.y)*(b.x-p.x));
  }
  return (area2-area)/area<0.0001;
}
function hitTest(triangle,x,y,r){
  for(var i=0;i<triangle.length;i++){

  }
}


</script>
